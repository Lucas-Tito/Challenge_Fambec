FROM mcr.microsoft.com/dotnet/sdk:9.0

# Install curl and other necessary tools
RUN apt-get update && apt-get install -y curl inotify-tools procps && rm -rf /var/lib/apt/lists/*

WORKDIR /src

# Copy project files first for better layer caching
COPY ["Challenge_Fambec.Client/Challenge_Fambec.Client.csproj", "Challenge_Fambec.Client/"]
COPY ["Challenge_Fambec.Shared/Challenge_Fambec.Shared.csproj", "Challenge_Fambec.Shared/"]

# Restore dependencies
RUN dotnet restore "Challenge_Fambec.Client/Challenge_Fambec.Client.csproj"

WORKDIR /src/Challenge_Fambec.Client

EXPOSE 80
EXPOSE 40565

# Configure hot reload environment variables
ENV DOTNET_USE_POLLING_FILE_WATCHER=true
ENV DOTNET_WATCH_RESTART_ON_RUDE_EDIT=true
ENV DOTNET_WATCH_SUPPRESS_LAUNCH_BROWSER=true
ENV DOTNET_WATCH_SUPPRESS_EMOJIS=true
ENV DOTNET_WATCH_SUPPRESS_MSBUILD_LOGO=true
ENV ASPNETCORE_ENVIRONMENT=Development
ENV ASPNETCORE_URLS=http://0.0.0.0:80
# Set the browser refresh to bind to all interfaces
ENV ASPNETCORE_BROWSERREFRESH_HOST=0.0.0.0
ENV ASPNETCORE_BROWSERREFRESH_PORT=40565

# Create a startup script that handles port configuration dynamically
RUN echo '#!/bin/bash\n\
export ASPNETCORE_BROWSERREFRESH_HOST=${CONTAINER_HOST:-0.0.0.0}\n\
export ASPNETCORE_BROWSERREFRESH_PORT=${BROWSER_REFRESH_PORT:-40565}\n\
echo "Starting Blazor WASM with hot reload..."\n\
echo "Browser refresh will be available at: ${ASPNETCORE_BROWSERREFRESH_HOST}:${ASPNETCORE_BROWSERREFRESH_PORT}"\n\
exec dotnet watch run --no-launch-profile --urls "http://0.0.0.0:80" --no-hot-reload-build-warning\n\
' > /usr/local/bin/start-blazor.sh && chmod +x /usr/local/bin/start-blazor.sh

CMD ["/usr/local/bin/start-blazor.sh"]